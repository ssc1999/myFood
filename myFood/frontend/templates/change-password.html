<!DOCTYPE html>
<html lang="en">

<head>
	<title>myFood</title>

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="icon" type="image/png" href="../images/icons/favicon.ico" />
	<link rel="stylesheet" type="text/css" href="../vendor/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css"
		href="../fonts/font-awesome-4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="../vendor/animate/animate.css">
	<link rel="stylesheet" type="text/css" href="../vendor/css-hamburgers/hamburgers.min.css">
	<link rel="stylesheet" type="text/css" href="../vendor/select2/select2.min.css">
	<link rel="stylesheet" type="text/css" href="../css/util.css">
	<link rel="stylesheet" type="text/css" href="../css/main.css">

</head>

<body>
	<div class="limiter">
		<div class="container-index">
			<div class="white-box">
				<h2>Change your password</h2>
				<form class="change-password-form" id="myForm">
					<div class="form-line">
						<label>Password</label>
						<input type="password" id="password" class="box" />
					</div>
					<div class="form-line">
						<label>Repeat password</label>
						<input type="password" id="password2" class="box" />
					</div>
					<button type="button" value="submit" id="submit" />Submit</button>
				</form>
				<div class="index-down-btn">
					<a href="/index.html">
						<button class="down-btn">Go Back</button>
					</a>
				</div>
				<div id="popup_container" class="popup-container">
					<div class="popup">
						<h4 id="resultH4"></h4>
						<p id="resultP"></p>
						<button id="close">Close</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
		const submit = document.getElementById("submit");
		const popup_container = document.getElementById('popup_container');
		const close = document.getElementById('close');

		close.addEventListener('click', () => {
			popup_container.classList.remove('show');
		});

		submit.addEventListener('click', () => {
			console.log("ha entrado solo mi rey");
			changePassword()
		});

		async function changePassword(event) {
			console.log("registerUser")

			const password = document.getElementById("password").value;
			const password2 = document.getElementById("password2").value;
			const token = localStorage.getItem("token");

			var title = undefined;
			var paragraph = undefined;
			console.log("Token: ", token)
			console.log("Password: ", password)
			if (password === password2) {
				const result = await fetch("/api/change-password", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
					},
					body: JSON.stringify({
						token,
						newPassword: password,
					})
				})
				const { status, error } = await result.json();

				const processErrorMessage = ({ code, message }) => {
					switch (code) {
						case 1:
							return "Password not long enough or doesn't include special characters."
						case 2:
							return "Invalid token"
						default:
							return `Unknown error: ${code}. ${message}`
					}
				}

				const isOk = status === 'ok'
				title = isOk
					? "Done!"
					: "Something went wrong"

				paragraph = isOk
					? "Password succesfully changed"
					: processErrorMessage(error)
			} else {
				title = "Error"
				paragraph = "Please introduce the same password in both textfields"
			}

			document.getElementById("resultH4").innerHTML = title
			document.getElementById("resultP").innerHTML = paragraph

			popup_container.classList.add('show');
		}
	</script>
	<!-- ------------------------SCRIPTS------------------------ -->
	<script src="../vendor/jquery/jquery-3.2.1.min.js"></script>

	<script src="../vendor/bootstrap/js/popper.js"></script>
	<script src="../vendor/bootstrap/js/bootstrap.min.js"></script>

	<script src="../vendor/select2/select2.min.js"></script>

	<script src="../vendor/tilt/tilt.jquery.min.js"></script>
	<script>
		$('.js-tilt').tilt({
			scale: 1.1
		})
	</script>

	<script src="../js/main.js"></script>

</body>

</html>